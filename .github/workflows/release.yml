# =============================================================================
# Release Workflow
# =============================================================================
# Publishes package to PyPI when a new release is created.
#
# Required Secrets:
#   - PYPI_API_TOKEN: API token for PyPI (if not using trusted publishing)
#
# Required Environment:
#   - pypi: GitHub environment configured for PyPI trusted publishing
#
# See: https://docs.pypi.org/trusted-publishers/

name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.0)"
        required: true
      publish_to:
        description: "Where to publish"
        required: true
        type: choice
        options:
          - testpypi
          - pypi
        default: testpypi

permissions:
  contents: read

jobs:
  # ===========================================================================
  # Build Job - Create distribution packages
  # ===========================================================================
  build:
    name: Build Distribution
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: "3.12"

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Get version
        id: version
        run: |
          VERSION=$(grep "__version__ =" src/unbitrium/__init__.py | cut -d '"' -f 2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build package
        run: python -m build

      - name: Check distribution
        run: twine check dist/*

      - name: Upload distribution artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: python-package-distributions
          path: dist/
          retention-days: 30

  # ===========================================================================
  # Publish to TestPyPI
  # ===========================================================================
  publish-testpypi:
    name: Publish to TestPyPI
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to == 'testpypi'
    environment:
      name: testpypi
      url: https://test.pypi.org/p/unbitrium
    permissions:
      id-token: write

    steps:
      - name: Download distributions
        uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: python-package-distributions
          path: dist/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@76f52bc884231f62b9a034ebfe128415bbaabdfc # v1.12.4
        with:
          repository-url: https://test.pypi.org/legacy/

  # ===========================================================================
  # Publish to PyPI
  # ===========================================================================
  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to == 'pypi')
    environment:
      name: pypi
      url: https://pypi.org/p/unbitrium
    permissions:
      id-token: write

    steps:
      - name: Download distributions
        uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: python-package-distributions
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@76f52bc884231f62b9a034ebfe128415bbaabdfc # v1.12.4
        # Uses trusted publishing - no API token needed
        # Configure at: https://pypi.org/manage/project/unbitrium/settings/publishing/

  # ===========================================================================
  # Create GitHub Release Assets
  # ===========================================================================
  release-assets:
    name: Upload Release Assets
    runs-on: ubuntu-latest
    needs: [build, publish-pypi]
    if: github.event_name == 'release'
    permissions:
      contents: write

    steps:
      - name: Download distributions
        uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: python-package-distributions
          path: dist/

      - name: Upload assets to release
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Post-release Notifications
  # ===========================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: publish-pypi
    if: success()

    steps:
      - name: Log success
        run: |
          echo "Successfully published version ${{ needs.build.outputs.version }} to PyPI"
