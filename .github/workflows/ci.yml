# =============================================================================
# Continuous Integration Workflow
# =============================================================================
# This workflow runs on every push and pull request to ensure code quality
# and correctness across multiple Python versions and operating systems.
#
# Required Secrets:
#   - CODECOV_TOKEN: Token for uploading coverage reports to Codecov
#
# See: https://docs.github.com/en/actions

name: CI

on:
  push:
    branches: ["main", "develop"]
    paths:
      - "src/**"
      - "tests/**"
      - "pyproject.toml"
      - ".github/workflows/ci.yml"
  pull_request:
    branches: ["main", "develop"]
    paths:
      - "src/**"
      - "tests/**"
      - "pyproject.toml"
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: "Run with debug logging"
        required: false
        default: "false"

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: "1"
  FORCE_COLOR: "1"

jobs:
  # ===========================================================================
  # Test Job - Multi-platform, Multi-Python testing
  # ===========================================================================
  test:
    name: Test / ${{ matrix.os }} / Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        exclude:
          # Exclude combinations that are known to fail
          - os: macos-latest
            python-version: "3.10"

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e ".[dev]"

      - name: Run tests with pytest
        run: |
          pytest tests/ \
            --cov=src/unbitrium \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --junitxml=junit.xml \
            -v \
            --tb=short

      - name: Upload test results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: test-results-${{ matrix.os }}-${{ matrix.python-version }}
          path: |
            junit.xml
            htmlcov/
          retention-days: 7

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@0565863a31f2c772f9f0395002a31e3f06189574 # v5.4.0
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12'
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage to Code Climate
        uses: paambaati/codeclimate-action@v6
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12'
        env:
          CC_TEST_REPORTER_ID: ${{ secrets.CODECLIMATE_TOKEN }}
        with:
          coverageLocations: coverage.xml:coverage.py
        continue-on-error: true

  # ===========================================================================
  # Summary Job - Aggregate results
  # ===========================================================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: test
    if: always()
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test.result }}" == "failure" ]; then
            echo "Tests failed!"
            exit 1
          fi
          echo "All tests passed!"
